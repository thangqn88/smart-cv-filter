@model SmartCVFilter.Web.Models.CreateApplicantRequest
@{
    ViewData["Title"] = "Add New Applicant";
    Layout = "_Layout";
    var jobPostId = ViewData["JobPostId"];
}

<!-- Welcome Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3">
            <div>
                <h1 class="h2 mb-1 text-dark">
                    <i class="bi bi-person-plus text-primary me-2"></i>
                    Add New Applicant
                </h1>
                <p class="text-muted mb-0">Add a new candidate to the application pool</p>
            </div>
            <div class="btn-toolbar mb-2 mb-md-0">
                <a href="@Url.Action("Index", new { jobPostId = jobPostId })" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-1"></i>
                    Back to List
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Search Existing Applicant Section -->
<div class="row mb-4" id="searchSection">
    <div class="col-12">
        <div class="card shadow-lg border-0">
            <div class="card-header bg-white border-0 py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-bold text-dark">
                        <i class="bi bi-search text-primary me-2"></i>
                        Search Existing Applicant
                    </h5>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="toggleSearchBtn">
                        <i class="bi bi-x me-1"></i>
                        Close
                    </button>
                </div>
            </div>
            <div class="card-body p-4">
                <div class="row">
                    <div class="col-md-8">
                        <label for="applicantSearch" class="form-label fw-bold text-dark">Search by Name or Email</label>
                        <div class="input-group">
                            <span class="input-group-text bg-white border-end-0">
                                <i class="bi bi-search text-muted"></i>
                            </span>
                            <input type="text" id="applicantSearch" class="form-control border-start-0"
                                placeholder="Type name or email to search..." autocomplete="off" />
                        </div>
                        <small class="text-muted">Search for existing applicants in the database</small>
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button type="button" class="btn btn-primary w-100" id="searchApplicantBtn">
                            <i class="bi bi-search me-1"></i>
                            Search
                        </button>
                    </div>
                </div>
                <div id="searchResults" class="mt-3" style="display: none;">
                    <div class="list-group" id="applicantResultsList">
                        <!-- Results will be populated here -->
                    </div>
                </div>
                <div id="searchNoResults" class="mt-3 alert alert-info" style="display: none;">
                    <i class="bi bi-info-circle me-2"></i>
                    No existing applicants found. You can create a new applicant below.
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toggle Button -->
<div class="row mb-4" id="toggleSection" style="display: none;">
    <div class="col-12">
        <button type="button" class="btn btn-outline-primary" id="showSearchBtn">
            <i class="bi bi-search me-1"></i>
            Search Existing Applicant
        </button>
    </div>
</div>

<form asp-controller="Applicants" asp-action="Create" method="post" class="needs-validation" novalidate
    enctype="application/x-www-form-urlencoded">
    @Html.AntiForgeryToken()
    <input type="hidden" name="jobPostId" value="@jobPostId" />

    <div class="row">
        <div class="col-lg-8">
            <!-- Personal Information -->
            <div class="card shadow-lg border-0 mb-4">
                <div class="card-header bg-white border-0 py-4">
                    <h5 class="mb-1 fw-bold text-dark">
                        <i class="bi bi-person text-primary me-2"></i>
                        Personal Information
                    </h5>
                    <p class="text-muted mb-0">Basic candidate information</p>
                </div>
                <div class="card-body p-4">
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <label for="FirstName" class="form-label fw-bold text-dark">First Name *</label>
                            <div class="input-group">
                                <span class="input-group-text bg-white border-end-0">
                                    <i class="bi bi-person text-muted"></i>
                                </span>
                                <input type="text" id="FirstName" name="FirstName" class="form-control border-start-0"
                                    placeholder="Enter first name" required />
                            </div>
                            <span asp-validation-for="FirstName" class="text-danger small"></span>
                        </div>

                        <div class="col-md-6 mb-4">
                            <label for="LastName" class="form-label fw-bold text-dark">Last Name *</label>
                            <div class="input-group">
                                <span class="input-group-text bg-white border-end-0">
                                    <i class="bi bi-person text-muted"></i>
                                </span>
                                <input type="text" id="LastName" name="LastName" class="form-control border-start-0"
                                    placeholder="Enter last name" required />
                            </div>
                            <span asp-validation-for="LastName" class="text-danger small"></span>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <label for="Email" class="form-label fw-bold text-dark">Email Address *</label>
                            <div class="input-group">
                                <span class="input-group-text bg-white border-end-0">
                                    <i class="bi bi-envelope text-muted"></i>
                                </span>
                                <input type="email" id="Email" name="Email" class="form-control border-start-0"
                                    placeholder="Enter email address" required />
                            </div>
                            <span asp-validation-for="Email" class="text-danger small"></span>
                        </div>

                        <div class="col-md-6 mb-4">
                            <label for="PhoneNumber" class="form-label fw-bold text-dark">Phone Number</label>
                            <div class="input-group">
                                <span class="input-group-text bg-white border-end-0">
                                    <i class="bi bi-telephone text-muted"></i>
                                </span>
                                <input type="text" id="PhoneNumber" name="PhoneNumber"
                                    class="form-control border-start-0" placeholder="Enter phone number" />
                            </div>
                            <span asp-validation-for="PhoneNumber" class="text-danger small"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Professional Links -->
            <div class="card shadow-lg border-0 mb-4">
                <div class="card-header bg-white border-0 py-4">
                    <h5 class="mb-1 fw-bold text-dark">
                        <i class="bi bi-link-45deg text-primary me-2"></i>
                        Professional Links
                    </h5>
                    <p class="text-muted mb-0">Optional professional profiles and portfolios</p>
                </div>
                <div class="card-body p-4">
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <label for="LinkedInProfile" class="form-label fw-bold text-dark">LinkedIn
                                Profile</label>
                            <div class="input-group">
                                <span class="input-group-text bg-white border-end-0">
                                    <i class="bi bi-linkedin text-muted"></i>
                                </span>
                                <input type="text" id="LinkedInProfile" name="LinkedInProfile"
                                    class="form-control border-start-0"
                                    placeholder="https://linkedin.com/in/username" />
                            </div>
                            <span asp-validation-for="LinkedInProfile" class="text-danger small"></span>
                        </div>

                        <div class="col-md-6 mb-4">
                            <label for="PortfolioUrl" class="form-label fw-bold text-dark">Portfolio URL</label>
                            <div class="input-group">
                                <span class="input-group-text bg-white border-end-0">
                                    <i class="bi bi-globe text-muted"></i>
                                </span>
                                <input type="text" id="PortfolioUrl" name="PortfolioUrl"
                                    class="form-control border-start-0" placeholder="https://portfolio.com" />
                            </div>
                            <span asp-validation-for="PortfolioUrl" class="text-danger small"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cover Letter -->
            <div class="card shadow-lg border-0 mb-4">
                <div class="card-header bg-white border-0 py-4">
                    <h5 class="mb-1 fw-bold text-dark">
                        <i class="bi bi-file-text text-primary me-2"></i>
                        Cover Letter
                    </h5>
                    <p class="text-muted mb-0">Optional cover letter content</p>
                </div>
                <div class="card-body p-4">
                    <div class="mb-4">
                        <label for="CoverLetter" class="form-label fw-bold text-dark">Cover Letter</label>
                        <textarea id="CoverLetter" name="CoverLetter" class="form-control" rows="6"
                            placeholder="Enter cover letter or additional notes about the applicant..."></textarea>
                        <span asp-validation-for="CoverLetter" class="text-danger small"></span>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Preview Card -->
            <div class="card shadow-lg border-0 mb-4">
                <div class="card-header bg-white border-0 py-4">
                    <h5 class="mb-1 fw-bold text-dark">
                        <i class="bi bi-eye text-primary me-2"></i>
                        Live Preview
                    </h5>
                    <p class="text-muted mb-0">See how the applicant will appear</p>
                </div>
                <div class="card-body p-4">
                    <div id="previewContent">
                        <h6 class="text-muted">Applicant name will appear here</h6>
                        <p class="text-muted">Email address</p>
                        <p class="text-muted">Phone number</p>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="card shadow-lg border-0 mb-4">
                <div class="card-header bg-white border-0 py-4">
                    <h5 class="mb-1 fw-bold text-dark">
                        <i class="bi bi-lightning text-primary me-2"></i>
                        Actions
                    </h5>
                    <p class="text-muted mb-0">Save or cancel the form</p>
                </div>
                <div class="card-body p-4">
                    <div class="d-grid gap-3">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-check-circle me-1"></i>
                            Add Applicant
                        </button>
                        <a href="@Url.Action("Index", new { jobPostId = jobPostId })"
                            class="btn btn-outline-secondary btn-lg">
                            <i class="bi bi-x-circle me-1"></i>
                            Cancel
                        </a>
                    </div>
                </div>
            </div>

            <!-- Note -->
            <div class="alert alert-info border-0 shadow-sm">
                <i class="bi bi-info-circle me-2"></i>
                <strong>Note:</strong> After adding the applicant, you can upload CV files and start AI screening from
                the applicant details page.
            </div>
        </div>
    </div>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // Search functionality
        let searchTimeout;
        const searchInput = document.getElementById('applicantSearch');
        const searchBtn = document.getElementById('searchApplicantBtn');
        const searchResults = document.getElementById('searchResults');
        const searchNoResults = document.getElementById('searchNoResults');
        const applicantResultsList = document.getElementById('applicantResultsList');
        const searchSection = document.getElementById('searchSection');
        const toggleSection = document.getElementById('toggleSection');
        const showSearchBtn = document.getElementById('showSearchBtn');
        const toggleSearchBtn = document.getElementById('toggleSearchBtn');

        // Toggle search section
        if (showSearchBtn) {
            showSearchBtn.addEventListener('click', function() {
                searchSection.style.display = 'block';
                toggleSection.style.display = 'none';
                searchInput.focus();
            });
        }

        if (toggleSearchBtn) {
            toggleSearchBtn.addEventListener('click', function() {
                searchSection.style.display = 'none';
                toggleSection.style.display = 'block';
                searchInput.value = '';
                searchResults.style.display = 'none';
                searchNoResults.style.display = 'none';
            });
        }

        // Search on button click
        if (searchBtn) {
            searchBtn.addEventListener('click', performSearch);
        }

        // Search on Enter key
        if (searchInput) {
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    performSearch();
                }
            });

            // Real-time search with debounce
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                const searchTerm = this.value.trim();
                
                if (searchTerm.length >= 2) {
                    searchTimeout = setTimeout(performSearch, 500);
                } else {
                    searchResults.style.display = 'none';
                    searchNoResults.style.display = 'none';
                }
            });
        }

        async function performSearch() {
            const searchTerm = searchInput.value.trim();
            
            if (!searchTerm || searchTerm.length < 2) {
                if (typeof showWarning === 'function') {
                    showWarning('Please enter at least 2 characters to search.', 'Search Input Required');
                } else {
                    alert('Please enter at least 2 characters to search.');
                }
                return;
            }

            searchBtn.disabled = true;
            searchBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Searching...';
            searchResults.style.display = 'none';
            searchNoResults.style.display = 'none';

            console.log('[ApplicantSearch] Starting search with term:', searchTerm);

            try {
                const searchUrl = `/api/applicantssearch?search=${encodeURIComponent(searchTerm)}`;
                console.log('[ApplicantSearch] Request URL:', searchUrl);

                const response = await fetch(searchUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    credentials: 'include'
                });

                console.log('[ApplicantSearch] Response status:', response.status, response.statusText);
                console.log('[ApplicantSearch] Response headers:', Object.fromEntries(response.headers.entries()));

                if (!response.ok) {
                    let errorMessage = `Search failed with status ${response.status}`;
                    let errorDetails = null;

                    // Read response body as text first (can only be read once)
                    const responseText = await response.text();
                    console.error('[ApplicantSearch] Error response text:', responseText);

                    // Try to parse as JSON
                    try {
                        errorDetails = JSON.parse(responseText);
                        errorMessage = errorDetails.message || errorMessage;
                        console.error('[ApplicantSearch] Error response data:', errorDetails);
                    } catch (parseError) {
                        // If not JSON, use the text as error message
                        errorMessage = responseText || `Search failed: ${response.statusText || 'Unknown error'}`;
                        console.error('[ApplicantSearch] Failed to parse error response as JSON:', parseError);
                    }

                    // Log detailed error information
                    console.error('[ApplicantSearch] Search failed:', {
                        status: response.status,
                        statusText: response.statusText,
                        url: searchUrl,
                        errorDetails: errorDetails,
                        responseText: responseText
                    });

                    // Show user-friendly error notification
                    if (typeof showError === 'function') {
                        showError(
                            errorMessage + (errorDetails?.error ? ` (${errorDetails.error})` : ''),
                            'Search Error',
                            0 // Don't auto-dismiss errors
                        );
                    } else {
                        alert(`Error: ${errorMessage}`);
                    }

                    return;
                }

                const applicants = await response.json();
                console.log('[ApplicantSearch] Search successful. Results count:', applicants?.length || 0);
                
                if (applicants && applicants.length > 0) {
                    displaySearchResults(applicants);
                    if (typeof showSuccess === 'function') {
                        showSuccess(`Found ${applicants.length} matching applicant(s).`, 'Search Complete', 3000);
                    }
                } else {
                    searchNoResults.style.display = 'block';
                    searchResults.style.display = 'none';
                    console.log('[ApplicantSearch] No results found for term:', searchTerm);
                }
            } catch (error) {
                // Log detailed error information
                console.error('[ApplicantSearch] Exception occurred:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack,
                    searchTerm: searchTerm
                });

                // Show user-friendly error notification
                const errorMessage = error.message || 'An unexpected error occurred while searching.';
                if (typeof showError === 'function') {
                    showError(
                        `${errorMessage} Please check your connection and try again.`,
                        'Search Error',
                        0 // Don't auto-dismiss errors
                    );
                } else {
                    alert(`Error: ${errorMessage}`);
                }
            } finally {
                searchBtn.disabled = false;
                searchBtn.innerHTML = '<i class="bi bi-search me-1"></i>Search';
            }
        }

        function displaySearchResults(applicants) {
            applicantResultsList.innerHTML = '';
            
            applicants.forEach(applicant => {
                const listItem = document.createElement('a');
                listItem.href = '#';
                listItem.className = 'list-group-item list-group-item-action';
                listItem.innerHTML = `
                    <div class="d-flex w-100 justify-content-between">
                        <div>
                            <h6 class="mb-1">${escapeHtml(applicant.firstName)} ${escapeHtml(applicant.lastName)}</h6>
                            <p class="mb-1 text-muted">${escapeHtml(applicant.email)}</p>
                            ${applicant.phoneNumber ? `<small class="text-muted">${escapeHtml(applicant.phoneNumber)}</small>` : ''}
                        </div>
                        <small class="text-muted">${applicant.jobTitle || 'Previous Application'}</small>
                    </div>
                `;
                
                listItem.addEventListener('click', function(e) {
                    e.preventDefault();
                    selectApplicant(applicant);
                });
                
                applicantResultsList.appendChild(listItem);
            });
            
            searchResults.style.display = 'block';
            searchNoResults.style.display = 'none';
        }

        function selectApplicant(applicant) {
            // Populate form fields
            document.getElementById('FirstName').value = applicant.firstName || '';
            document.getElementById('LastName').value = applicant.lastName || '';
            document.getElementById('Email').value = applicant.email || '';
            document.getElementById('PhoneNumber').value = applicant.phoneNumber || '';
            document.getElementById('LinkedInProfile').value = applicant.linkedInProfile || '';
            document.getElementById('PortfolioUrl').value = applicant.portfolioUrl || '';
            document.getElementById('CoverLetter').value = applicant.coverLetter || '';

            // Update preview
            updatePreview();

            // Show success message
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show mt-3';
            alertDiv.innerHTML = `
                <i class="bi bi-check-circle me-2"></i>
                Applicant information loaded. You can modify the details if needed before submitting.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            searchSection.querySelector('.card-body').insertBefore(alertDiv, searchSection.querySelector('.card-body').firstChild);

            // Scroll to form
            document.querySelector('form').scrollIntoView({ behavior: 'smooth', block: 'start' });

            // Hide search section
            searchSection.style.display = 'none';
            toggleSection.style.display = 'block';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Live preview functionality
        function updatePreview() {
            const firstName = document.getElementById('FirstName')?.value || 'First';
            const lastName = document.getElementById('LastName')?.value || 'Last';
            const email = document.getElementById('Email')?.value || 'email@example.com';
            const phone = document.getElementById('PhoneNumber')?.value || 'Not provided';

            const previewContent = document.getElementById('previewContent');
            if (previewContent) {
                previewContent.innerHTML = `
                    <h6>${escapeHtml(firstName)} ${escapeHtml(lastName)}</h6>
                    <p class="text-muted">${escapeHtml(email)}</p>
                    <p class="text-muted">${escapeHtml(phone)}</p>
                `;
            }
        }

        // Add event listeners for live preview
        document.querySelectorAll('#FirstName, #LastName, #Email, #PhoneNumber').forEach(element => {
            element.addEventListener('input', updatePreview);
        });

        // Form validation debugging
        document.querySelector('form').addEventListener('submit', function (e) {
            console.log('Form submission started');

            // Check form data
            const formData = new FormData(this);
            console.log('Form data:');
            for (let [key, value] of formData.entries()) {
                console.log(key + ': ' + value);
            }

            // Check required fields using ID selectors
            const firstName = document.getElementById('FirstName')?.value || '';
            const lastName = document.getElementById('LastName')?.value || '';
            const email = document.getElementById('Email')?.value || '';

            console.log('Required fields check:');
            console.log('FirstName:', firstName, 'Length:', firstName.length);
            console.log('LastName:', lastName, 'Length:', lastName.length);
            console.log('Email:', email, 'Length:', email.length);

            // Only prevent submission if fields are actually empty, don't interfere with normal validation
            if (!firstName || firstName.trim() === '') {
                console.error('FirstName is empty');
                // Don't prevent default - let the form validation handle it
                return;
            }

            if (!lastName || lastName.trim() === '') {
                console.error('LastName is empty');
                // Don't prevent default - let the form validation handle it
                return;
            }

            if (!email || email.trim() === '') {
                console.error('Email is empty');
                // Don't prevent default - let the form validation handle it
                return;
            }

            console.log('Form validation passed, submitting...');
        });

        // Initialize preview
        updatePreview();
    </script>
}
